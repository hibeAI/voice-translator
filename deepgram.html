<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>
<body>
  <form id="form">
    <label for="deepgram_key">Deepgram Key:</label>
    <input type="text" name="deepgram_key" required>
    <label for="openai_key">OpenAI Key:</label>
    <input type="text" name="openai_key" required>
    <button type="submit">Start</button>
    <button type="button" disabled>Stop</button>
  </form>
  <p id="status">Not Connected</p>
  <p id="transcript"></p>
  <script>
    document.getElementById('form').addEventListener('submit', async (event) => {
      event.preventDefault();

      const formData = new FormData(event.target);
      const deepgramKey = formData.get('deepgram_key');
      const openAiKey = formData.get('openai_key');

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        const socket = new WebSocket('wss://api.deepgram.com/v1/listen', ['token', deepgramKey]);

        socket.onopen = () => {
          document.getElementById('status').textContent = 'Connected';
          const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

          mediaRecorder.addEventListener('dataavailable', async (event) => {
            if (event.data.size > 0 && socket.readyState == 1) {
              socket.send(event.data);
            }
          });

          mediaRecorder.start(1000);
        };

        socket.onmessage = async (message) => {
          const received = JSON.parse(message.data);
          const transcript = received.channel.alternatives[0].transcript;

          if (transcript && received.is_final) {
            const translation = await getTranslation(transcript, openAiKey);
            document.getElementById('transcript').textContent += translation + ' ';
          }
        };

        socket.onclose = () => {
          document.getElementById('status').textContent = 'Disconnected';
        };

        socket.onerror = (error) => {
          console.error('WebSocket error:', error);
        };

        document.querySelector('button[type="button"]').addEventListener('click', () => {
          mediaRecorder.stop();
          stream.getTracks().forEach(track => track.stop());
          socket.close();
        });
      });
    });

    async function getTranslation(text, openAiKey) {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${openAiKey}`,
        },
        body: JSON.stringify({
          messages: [
            { role: 'system', content: 'You are an English to Spanish translator. Reply ONLY with the Spanish translation of the text. Do not translate "United Roofing," write it as is. Translate "you" in the text to the plural form in Spanish (verbs and everything).' },
            { role: 'user', content: text },
          ],
          model: 'gpt-4',
        }),
      });

      const result = await response.json();
      return result.choices[0].message.content.trim();
    }
  </script>
</body>
</html>
